#! /usr/bin/env bash

DESTRUCTURE_MODE=list

mkuuid () {
  od -x /dev/urandom | head -1 | awk '{
    OFS="-"; sub(/./,"4",$5); srand($6);
    sub(/./,substr("89ab",rand()*4,1),$6); print $2$3,$4,$5,$6,$7$8$9}'
}

if [[ -d content ]]; then
  pathroot=content/
fi

# TODO: Set this for comparison if an output filename is specified
# (this will make more sense in a future iteration of this script)
DESTRUCTURE_LEVEL=content

if [[ $DESTRUCTURE_LEVEL != content ]]; then
  linkroot=$pathroot
fi

gitmode=$(git rev-parse --is-inside-work-tree 2>/dev/null)

if [[ $# == 0 ]]; then
  echo "Usage: mkdir content && bagtent-destructure [^A-Z]*.md" >&2
fi

for file in "$@"; do
  newname=$(mkuuid).md
  if [[ $DESTRUCTURE_MODE == map ]]; then
    echo "- [$file][]" >> LIST.md
    echo "[$file]: $linkroot$newname" >> LINKS.md
  else
    echo "- [$file]($linkroot$newname)" >> LIST.md
  fi
  if [[ -n "$gitmode" ]]; then
    git mv "$file" "$pathroot$newname"
  else
    mv "$file" "$pathroot$newname"
  fi
done
